@{
    Layout = null;
}

<!DOCTYPE html>

<html>
<head>
    <meta name="viewport" content="width=device-width" />
    <title>生产管理</title>
    <link href="~/Scripts/jquery-easyui-1.4.4/themes/bootstrap/easyui.css" rel="stylesheet" />
    <script src="~/Scripts/jquery-easyui-1.4.4/jquery.min.js"></script>
    <script src="~/Scripts/jquery-easyui-1.4.4/jquery.easyui.min.js"></script>
    <script src="~/Scripts/jquery-easyui-1.4.4/locale/easyui-lang-zh_CN.js"></script>
    <link href="~/Content/themes/icon.css" rel="stylesheet" />
    <script src="~/Content/js/common.js"></script>
    <link href="~/Content/themes/table.css" rel="stylesheet" />
    <script src="~/Scripts/jquery-easyui-1.4.4/Extension/jquery-easyui-datagridview/datagrid-detailview.js"></script>

    <script type="text/javascript">
        $(function () {
            $.ajax({     //请求当前用户可以操作的按钮
                url: "/Button/GetUserAuthorizeButton?r=" + Math.random(),
                type: "post",
                data: { "KeyCode": "produceOrder", "KeyName": "Produce" },
                dataType: "json",
                timeout: 5000,
                success: function (data) {
                    if (data.success) {
                        var toolbar = getToolBar(data);      //common.js
                        if (data.search) {     //判断是否有浏览权限
                            $("#ui_produce_dg").datagrid({
                                url: "/Produce/GetAllProduceInfo",                                
                                striped: true, rownumbers: true, pagination: true, pageSize: 20, singleSelect: true,
                                idField: 'FBillNo',
                                sortName: 'FBillNo',
                                sortOrder: 'desc',
                                pageList: [20, 40, 60, 80, 100],
                                frozenColumns: [[
                                                 { width: 100, title: '订单号', field: 'FBillNo', sortable: true },
                                                 { width: 100, title: '制单日期', field: '', hidden: true },
                                                 { width: 25, title: '订单状态', field: 'FStatus' },
                                                  {
                                                      width: 25, title: '关闭标志', field: '', hidden:true,
                                                      formatter: function (value, row, index) {
                                                          return value ? '<img src="../../Content/themes/icon/chk_checked.gif" alt="已关闭" title="用户已关闭" />' : '<img src="../../Content/themes/icon/chk_unchecked.gif" alt="未关闭" title="用户未关闭" />';
                                                      }
                                                  },
                                                   { width: 100, title: '物料名称', field: 'FName' }
                                                  
                                                
                                ]],
                                columns: [[
                                             { width: 100, title: '规格型号', field: 'FModel' },
                                                     { width: 80, title: '计划数量', field: 'FQty' },
                                                      { width: 80, title: '实际数量', field: 'FCommitQty' },
                                                       { width: 80, title: '入库数量', field: '', hidden: true },
                                                        { width: 100, title: '计划开工日期', field: 'FPlanCommitDate', formatter: function (value, row, index) { return getDate(value, row, index) } },
                                                         { width: 100, title: '计划完工日期', field: 'FPlanFinishDate', formatter: function (value, row, index) { return getDate(value, row, index) } },
                                                         { width: 100, title: '单据下达日期', field: '', formatter: function (value, row, index) { return getDate(value, row, index) }, hidden: true },
                                                         { width: 100, title: '实际开工日期', field: 'FStartDate', formatter: function (value, row, index) { return getDate(value, row, index) } },
                                                         { width: 100, title: '实际完工日期', field: 'FFinishDate', formatter: function (value, row, index) { return getDate(value, row, index) } },
                                                         { width: 100, title: '表单类型', field: 'FType' },
                                                         { width: 100, title: '是否领料', field: '', hidden:true       },
                                                         { width: 100, title: '物料代码', field: 'FItemID' }
                                ]],                              
                                toolbar: toolbar.length == 0 ? null : toolbar
                              
                                //view: detailview,
                                //detailFormatter: function(rowIndex, rowData){
                                //    return '<table><tr>' +
                                //            '<td >' + rowData.FPlanCommitDate + '</td>' +
                                //            '<td style="border:0">' +
                                //            '<p>Attribute: ' + rowData.FModel + '</p>' +
                                //            '<p>Status: ' + rowData.FItemID + '</p>' +
                                //            '</td>' + rowIndex +
                                //            '</tr></table>';
                                //}
                               
                                
                            }).datagrid('subgrid',conf);
                        }
                        else {
                            $.show_alert("提示", "无权限，请联系管理员！");
                        }
                    } else {
                        $.show_alert("错误", data.result);
                    }
                },
                error: function (XMLHttpRequest, textStatus, errorThrown) {
                    if (textStatus == "timeout") {
                        $.show_alert("提示", "请求超时，请刷新当前页重试！");
                    }
                    else {
                        $.show_alert("错误", textStatus + "：" + errorThrown);
                    }
                }
            })
        });

        var conf = {
            options:{
                //the master grid options
            },
            subgrid: {
                options: {
                    fitColumns: true,
                    foreignField: 'FBillNo',
                    url: "/Produce/GetAllProduceDetail",
                    striped: true, rownumbers: true, pagination: true, pageSize: 10, singleSelect: true,
                    idField: 'FBillNo',
                    sortName: 'FBillNo',
                    sortOrder: 'desc',
                    pageList: [5, 8, 10, 15, 20],
                    columns: [[
                        { width: 100, title: '订单号', field: 'FBillNo', sortable: true },
                             { width: 100, title: '制单日期', field: '', hidden: true },
                             { width: 25, title: '订单状态', field: 'FStatus' },
                              {
                                  width: 25, title: '关闭标志', field: '', hidden: true,
                                  formatter: function (value, row, index) {
                                      return value ? '<img src="../../Content/themes/icon/chk_checked.gif" alt="已关闭" title="用户已关闭" />' : '<img src="../../Content/themes/icon/chk_unchecked.gif" alt="未关闭" title="用户未关闭" />';
                                  }
                              },
                               { width: 100, title: '物料名称', field: 'FName' },
                         { width: 100, title: '规格型号', field: 'FModel' },
                                 { width: 80, title: '计划数量', field: 'FQty' },
                                  { width: 80, title: '实际数量', field: 'FCommitQty' },
                                   { width: 80, title: '入库数量', field: '', hidden: true },
                                    { width: 100, title: '计划开工日期', field: 'FPlanCommitDate', formatter: function (value, row, index) { return getDate(value, row, index) } },
                                     { width: 100, title: '计划完工日期', field: 'FPlanFinishDate', formatter: function (value, row, index) { return getDate(value, row, index) } },
                                     { width: 100, title: '单据下达日期', field: '', formatter: function (value, row, index) { return getDate(value, row, index) }, hidden: true },
                                     { width: 100, title: '实际开工日期', field: 'FStartDate', formatter: function (value, row, index) { return getDate(value, row, index) } },
                                     { width: 100, title: '实际完工日期', field: 'FFinishDate', formatter: function (value, row, index) { return getDate(value, row, index) } },
                                     { width: 100, title: '表单类型', field: 'FType' },
                                     { width: 100, title: '是否领料', field: '', hidden: true },
                                     { width: 100, title: '物料代码', field: 'FItemID' }
                    ]],
                    onResize: function () { },
                    onLoadSuccess: function () {
                        $('#subDatagrid').datagrid('fixDetailRowHeight', index);
                    }

                }
            }
        };


        //添加用户
        function AddProduce() {
            $("<div/>").dialog({
                id: "ui_user_add_dialog",
                href: "/User/UserAdd",
                title: "添加生产任务",
                height: 370,
                width: 610,
                modal: true,
                buttons: [{
                    id: "ui_user_add_btn",
                    text: '添 加',
                    handler: function () {
                        $("#UserAddForm").form("submit", {
                            url: "/User/AddUser",
                            onSubmit: function (param) {
                                param.UserID = $("#txtUserIDAdd").val();
                                param.UserName = $("#txtUserNameAdd").val();
                                param.Isable = document.getElementById("selUserIsableAdd").checked;
                                param.IfChangepwd = document.getElementById("selIfChangepwdAdd").checked;
                                param.Description = $("#txtUserDescriptionAdd").val();
                                param.MobilePhone = $("#txtMobilePhone").val();
                                param.Email = $("#txtEmail").val();
                                if ($(this).form('validate')) {
                                    $('#ui_user_add_btn').linkbutton('disable');
                                    return true;
                                }
                                else {
                                    $('#ui_user_add_btn').linkbutton('enable');   //恢复按钮
                                    return false;
                                }
                            },
                            success: function (data) {
                                var dataJson = eval('(' + data + ')');
                                if (dataJson.success) {
                                    $("#ui_user_add_dialog").dialog('destroy');
                                    $.show_alert("提示", dataJson.msg);
                                    $("#ui_user_dg").datagrid("reload").datagrid('clearSelections').datagrid('clearChecked');
                                } else {
                                    $('#ui_user_add_btn').linkbutton('enable');
                                    $.show_alert("提示", dataJson.msg);
                                }
                            }
                        });
                    }
                }, {
                    text: '取 消',
                    handler: function () {
                        $("#ui_user_add_dialog").dialog('destroy');
                    }
                }],
                onLoad: function () {
                    $("#txtUserIDAdd").focus();
                },
                onClose: function () {
                    $("#ui_user_add_dialog").dialog('destroy');  //销毁dialog对象
                }
            });
        }

        //修改计划
        function EditProduce() {
            var row = $("#ui_user_dg").datagrid("getChecked");
            if (row.length < 1) {
                $.show_alert("提示", "请先勾选要修改的计划");
                return;
            }
            if (row.length > 1) {
                $.show_alert("提示", "不支持批量修改计划");
                $("#ui_user_dg").datagrid('clearSelections').datagrid('clearChecked');
                return;
            }
            $("<div/>").dialog({
                id: "ui_user_edit_dialog",
                href: "/User/UserEdit",
                title: "修改生产计划",
                height: 370,
                width: 610,
                modal: true,
                buttons: [{
                    id: "ui_user_edit_btn",
                    text: '修 改',
                    handler: function () {
                        $("#UserEditForm").form("submit", {
                            url: "/User/EditUser",
                            onSubmit: function (param) {
                                param.id = $("#hidid").val();
                                param.originalName = $("#hidoriginalName").val();
                                param.UserID = $("#txtUserIDEdit").val()
                                param.UserName = $("#txtUserNameEdit").val();
                                param.Isable = document.getElementById("selUserIsableEdit").checked;
                                param.IfChangepwd = document.getElementById("selIfChangepwdEdit").checked;
                                param.Description = $("#txtUserDescriptionEdit").val();
                                param.MobilePhone = $("#txtMobilePhone").val();
                                param.Email = $("#txtEmail").val();
                                if ($(this).form('validate')) {
                                    $('#ui_user_edit_btn').linkbutton('disable');
                                    return true;
                                }
                                else {
                                    $('#ui_user_edit_btn').linkbutton('enable');
                                    return false;
                                }
                            },
                            success: function (data) {
                                var dataJson = eval('(' + data + ')');
                                if (dataJson.success) {
                                    $("#ui_user_edit_dialog").dialog('destroy');
                                    $.show_alert("提示", dataJson.msg);
                                    $("#ui_user_dg").datagrid("reload").datagrid('clearSelections').datagrid('clearChecked');
                                } else {
                                    $('#ui_user_edit_btn').linkbutton('enable');
                                    $.show_alert("提示", dataJson.msg);
                                }
                            }
                        });
                    }
                }, {
                    text: '取 消',
                    handler: function () {
                        $("#ui_user_edit_dialog").dialog('destroy');
                    }
                }],
                onLoad: function () {
                    $("#hidid").val(row[0].ID);
                    $("#hidoriginalName").val(row[0].AccountName);
                    $("#txtUserIDEdit").val(row[0].AccountName);
                    $("#txtUserNameEdit").val(row[0].RealName);
                    if (row[0].IsAble) {
                        $("#selUserIsableEdit").attr("checked", "checked");
                    }
                    if (row[0].IfChangePwd) {
                        $("#selIfChangepwdEdit").attr("checked", "checked");
                    }
                    $("#txtUserDescriptionEdit").val(row[0].Description);
                    $("#txtMobilePhone").val(row[0].MobilePhone);
                    $("#txtEmail").val(row[0].Email);
                },
                onClose: function () {
                    $("#ui_user_edit_dialog").dialog('destroy');  //销毁dialog对象
                }
            });
        }

        //删除计划（可批量）
        function DelProduce() {
            var rows = $("#ui_user_dg").datagrid("getChecked");
            if (rows.length < 1) {
                $.show_alert("提示", "请先勾选要删除的计划");
                return;
            }
            $.messager.confirm('提示', '确定删除选中行吗？', function (r) {
                if (r) {
                    var parmIds = "";
                    $.each(rows, function (i, row) {
                        parmIds += row.ID + ",";
                    });
                    parmIds = parmIds.substring(0, parmIds.length - 1);
                    $.ajax({
                        url: "/User/DelUserByIDs",
                        data: {
                            IDs: parmIds
                        },
                        type: "POST",
                        dataType: "json",
                        success: function (data) {
                            if (data.success) {
                                $.show_alert("提示", data.msg);
                                $("#ui_user_dg").datagrid("reload").datagrid('clearSelections').datagrid('clearChecked');
                            } else {
                                $.show_alert("提示", data.msg);
                            }
                        }
                    });
                }
            });
        }

        //角色设置（可批量）
        function SetUserRole() {
            var row = $("#ui_user_dg").datagrid("getChecked");
            if (row.length < 1) {
                $.show_alert("提示", "请先勾选要设置角色的用户");
                return;
            }
            $("<div/>").dialog({
                id: "ui_user_setrole_dialog",
                href: "/User/UserRole",
                title: row.length == 1 ? "设置角色" : "批量设置角色：" + row.length + "个用户",
                height: 220,
                width: 380,
                modal: true,
                buttons: [{
                    id: "ui_user_setrole_btn",
                    text: '确 定',
                    handler: function () {
                        $("#SetRoleForm").form("submit", {
                            url: "/User/SetUserRole",
                            onSubmit: function (param) {
                                $('#ui_user_setrole_btn').linkbutton('disable');
                                param.UserIDs = $("#hiduserid").val();
                                param.RoleIDs = $("#comboxrole").combobox('getValues');
                            },
                            success: function (data) {
                                var dataJson = eval('(' + data + ')');
                                if (dataJson.success) {
                                    $("#ui_user_setrole_dialog").dialog('destroy');
                                    $.show_alert("提示", dataJson.msg);
                                    $("#ui_user_dg").datagrid("reload").datagrid('clearSelections').datagrid('clearChecked');
                                } else {
                                    $('#ui_user_setrole_btn').linkbutton('enable');
                                    $.show_alert("提示", dataJson.msg);
                                }
                            }
                        });
                    }
                }],
                onLoad: function () {
                    //如果是设置一个用户就自动勾选已经有的角色
                    if (row.length == 1) {
                        $('#comboxrole').combobox('setValues', stringToList(row[0].UserRoleId));
                        $("#hiduserid").val(row[0].ID);
                        $("#txtusernameR").val(row[0].AccountName);
                    }
                    else {
                        var userids = "";
                        var usernames = "";
                        for (var i = 0; i < row.length; i++) {
                            userids += row[i].ID + ",";
                            usernames += row[i].AccountName + ",";
                        }
                        $("#hiduserid").val(userids.substring(0, userids.length - 1));
                        $("#txtusernameR").val(usernames.substring(0, usernames.length - 1));
                    }
                },
                onClose: function () {
                    $("#ui_user_setrole_dialog").dialog('destroy');  //销毁dialog对象
                }
            });
        }

        function ui_user_searchdata() {
            $("#ui_user_dg").datagrid('load', {
                accountid: $('#txtUserId').val(),
                username: $('#txtUserName').val(),
                isable: $('#selUserIsable').val(),
                ifchangepwd: $('#selIfChangepwd').val(),
                adddatestart: $('#txtAddBeginDate').datetimebox('getValue'),
                adddateend: $('#txtAddEndDate').datetimebox('getValue')
            });
            $("#ui_user_dg").datagrid('clearSelections').datagrid('clearChecked');
        }

        function ui_user_cleardata() {
            $('#ui_user_search input').val('');
            $('#ui_user_search select').val('select');
            $('#txtAddBeginDate').datetimebox('setValue', '');
            $('#txtAddEndDate').datetimebox('setValue', '');
            $("#ui_user_dg").datagrid('load', {});

            $("#ui_user_dg").datagrid('clearSelections').datagrid('clearChecked');
        }

        //部门设置
        function SetUserDept() {
            var row = $("#ui_user_dg").datagrid("getChecked");
            if (row.length < 1) {
                $.show_alert("提示", "请先勾选要设置部门的用户");
                return;
            }
            $("<div/>").dialog({
                id: "setdepdialog",
                href: "/User/SetUserDept",
                title: row.length == 1 ? "设置部门" : "批量设置部门：" + row.length + "个用户",
                height: 220,
                width: 380,
                modal: true,
                buttons: [{
                    id: "ui_user_setdep_btn",
                    text: '确 定',
                    handler: function () {
                        $("#SetUserDeptForm").form("submit", {
                            url: "/User/UserDeptSet",
                            onSubmit: function (param) {
                                $('#ui_user_setdep_btn').linkbutton('disable');    //点击就禁用按钮，防止连击
                                var parentid = $("#treeDepartmentParentId").combotree("getValues").toString();
                                param.UserIds = $("#hidUserIdDept").val();
                                param.DeptIds = parentid;
                            },
                            success: function (data) {
                                var dataJson = eval('(' + data + ')');    //转成json格式
                                if (dataJson.success) {
                                    $("#setdepdialog").dialog('destroy');  //销毁dialog对象
                                    $.show_alert("提示", dataJson.msg);
                                    $("#ui_user_dg").datagrid("reload").datagrid('clearSelections').datagrid('clearChecked');
                                } else {
                                    $('#ui_user_setdep_btn').linkbutton('enable');   //恢复按钮
                                    $.show_alert("提示", dataJson.msg);
                                }
                            }
                        });
                    }
                }],
                onLoad: function () {
                    if (row.length == 1) {
                        $('#treeDepartmentParentId').combotree('setValues', stringToList(row[0].UserDepartmentId));
                        $("#hidUserIdDept").val(row[0].ID);
                        $("#txtUserNameDept").val(row[0].RealName);
                    }
                    else {
                        var userids = "";
                        var usernames = "";
                        for (var i = 0; i < row.length; i++) {
                            userids += row[i].ID + ",";
                            usernames += row[i].RealName + ",";
                        }
                        $("#hidUserIdDept").val(userids.substring(0, userids.length - 1));
                        $("#txtUserNameDept").val(usernames.substring(0, usernames.length - 1));
                    }
                },
                onClose: function () {
                    $("#setdepdialog").dialog('destroy');  //销毁dialog对象
                }
            });
        }
    </script>

</head>
<body>
    <div id="ui_user_layout" class="easyui-layout" data-options="fit:true,border:false">
        <div data-options="region:'north',split:true,border:true,collapsed:false" title="搜索条件" style="height:104px;">
            <div id="ui_user_search">
                <table class="tableForm" style="width: 99%; height: 100%; background: #F5F5F5;">
                    <tr>
                        <th>
                            订单号：
                        </th>
                        <td>
                            <input name="txtUserId" id="txtUserId" class="easyui-validatebox textbox" style="width:150px;height:22px;" />
                        </td>

                        <th>
                            物料名称：
                        </th>
                        <td>
                            <input name="txtUserName" id="txtUserName" class="easyui-validatebox textbox" style="width:150px;height:22px;" />
                        </td>

                        <th>
                            订单状态：
                        </th>
                        <td>
                            <select name="selUserIsable" id="selUserIsable">
                                <option value="select">请选择</option>
                                <option value="true">已完成</option>
                                <option value="false">未完成</option>
                            </select>
                        </td>
                        <th>
                            是否领料：
                        </th>
                        <td>
                            <select name="selIfChangepwd" id="selIfChangepwd">
                                <option value="select">请选择</option>
                                <option value="true">已领料</option>
                                <option value="false">未领料</option>
                            </select>
                        </td>
                    </tr>
                    <tr>
                        <th>
                            计划开工时间：
                        </th>
                        <td>
                            <input name="txtAddBeginDate" id="txtAddBeginDate" class="easyui-datetimebox"
                                   editable="false" style="width:150px;height:22px;" />
                        </td>

                        <th>
                            计划完工时间：
                        </th>
                        <td>
                            <input name="txtAddEndDate" id="txtAddEndDate" class="easyui-datetimebox"
                                   editable="false" style="width:150px;height:22px;" />
                        </td>
                        <td colspan="4">
                            <a href="javascript:void(0);" class="easyui-linkbutton" iconcls="icon-search" plain="true"
                               onclick="ui_user_searchdata();">搜索</a>
                            <a href="javascript:void(0);" class="easyui-linkbutton" iconcls="icon-clear" plain="true"
                               onclick="ui_user_cleardata();">清空条件</a>
                        </td>
                    </tr>
                </table>
            </div>
        </div>
        <div data-options="region:'center',border:false">
            <table id="ui_produce_dg" data-options="fit:true,border:false"></table>
        </div>
    </div>
</body>
</html>
